/*Mostrar todas las Observaciones junto con los nombres comunes de las Especies y los
nombres de las Áreas Protegidas*/

SELECT DISTINCT O.ID AS ID_OBSERVACION, 
       O.FECHA_HORA, 
       O.NUMERO_INDIVIDUOS,
       O.NOTAS AS NOTAS_OBSERVACION,
       E.NOMBRE_COMUN AS NOMBRE_COMUN_ESPECIE,
       AP.NOMBRE AS NOMBRE_AREA_PROTEGIDA 
FROM  OBSERVACION O
LEFT JOIN OBSERVACION_ESPECIE OE ON O.ID = OE.OBSERVACION_ID
LEFT JOIN  ESPECIE E ON OE.ESPECIE_ID = E.ID
JOIN AREA_PROTEGIDA AP ON O.AREA_PROTEGIDA_ID = AP.ID;


/*Mostrar las Actividades de Conservación realizadas en Áreas Protegidas con extensión
mayor a 100 km²:*/

SELECT AC.ID AS ACTIVIDAD_CONSERVACION_ID,
       AP.ID AS AREAPROTEGIDA_ID, 
       AC.FECHA_REALIZACION,
       AC.NOMBRE, 
       AC.DESCRIPCION
FROM ACTIVIDAD_CONSERVACION AC 
JOIN AREA_PROTEGIDA AP ON AC.AREA_PROTEGIDA_ID = AP.ID
WHERE AP.EXTENSION > 100;


/*Mostrar las Amenazas o Factores de Riesgo asociados a Áreas Protegidas junto con sus
detalles.*/

SELECT AP.ID AS AREA_PROTEGIDA_ID, 
       AP.NOMBRE AS NOMBRE_AREA_PROTEGIDA, 
       AR.ID AS AMENAZA_RIESGO_ID,
       AR.NOMBRE AS AMENAZA_RIESGO, 
       AR.DESCRIPCION AS DETALLES, 
       AA.DETALLE_AMENAZA
FROM AMENAZA_RIESGO AR 
JOIN AREA_AMENAZADA AA ON AR.ID = AA.AMENAZA_RIESGO_ID 
JOIN AREA_PROTEGIDA AP ON AP.ID = AA.AREA_PROTEGIDA_ID;


/*Mostrar el número total de Individuos Observados por Especie en cada Observación.*/


SELECT O.ID AS ID_OBSERVACION,
       OE.ESPECIE_ID, 
       E.NOMBRE_COMUN AS NOMBRE_COMUN_ESPECIE,
       E.NOMBRE_CIENTIFICO AS NOMBRE_CIENTIFICO_ESPECIE,
       OE.CANTIDAD_ESPECIE AS INDIVIDUOS_POR_ESPECIE
FROM OBSERVACION O
JOIN OBSERVACION_ESPECIE OE ON O.ID = OE.OBSERVACION_ID
JOIN ESPECIE E ON OE.ESPECIE_ID = E.ID
ORDER BY  O.ID, E.NOMBRE_COMUN;


/*Mostrar los Indicadores de Biodiversidad junto con la cantidad promedio de Registros de
Indicadores por Indicador.*/

WITH CTE_INDICADORES AS (
    SELECT IB.ID AS INDICADOR_ID, 
           IB.NOMBRE AS NOMBRE_INDICADOR, 
           IB.DESCRIPCION, 
           COUNT(RI.ID) AS CANTIDAD_REGISTROS
    FROM INDICADOR_BIODIVERSIDAD IB 
    LEFT JOIN  REGISTRO_INDICADOR RI ON IB.ID = RI.INDICADOR_BIODIVERSIDAD_ID
    GROUP BY IB.ID, IB.NOMBRE, IB.DESCRIPCION
)
SELECT INDICADOR_ID,
       NOMBRE_INDICADOR,
       DESCRIPCION, 
       CANTIDAD_REGISTROS
FROM CTE_INDICADORES 
UNION ALL
     SELECT 'TOTAL' AS INDICADOR_ID,
            '->' AS NOMBRE_INDICADOR,
            'PROMEDIO DE REGISTROS POR INDICADOR' AS DESCRIPCION,
            ROUND(AVG(CANTIDAD_REGISTROS), 2) AS CANTIDAD_REGISTROS
     FROM CTE_INDICADORES ;




/*Mostrar las Áreas Protegidas con la mayor cantidad de Observaciones.*/
SELECT AP.ID AS AREA_PROTEGIDA_ID, 
       AP.NOMBRE AS NOMBRE_AREA_PROTEGIDA, 
       COUNT(O.ID) AS CANTIDAD_OBSERVACIONES
FROM AREA_PROTEGIDA AP
LEFT JOIN OBSERVACION O ON AP.ID = O.AREA_PROTEGIDA_ID
GROUP BY AP.ID, AP.NOMBRE
ORDER BY CANTIDAD_OBSERVACIONES DESC;

/*Mostrar las Especies que han sido observadas en al menos tres Observaciones distintas*/

SELECT E.ID AS ESPECIE_ID, 
       E.NOMBRE_CIENTIFICO, 
       E.NOMBRE_COMUN, 
       COUNT(OE.OBSERVACION_ID) AS NUM_OBSERVACIONES
FROM ESPECIE E
JOIN OBSERVACION_ESPECIE OE ON E.ID = OE.ESPECIE_ID
GROUP BY E.ID, E.NOMBRE_CIENTIFICO, E.NOMBRE_COMUN
HAVING COUNT( OE.OBSERVACION_ID) >= 3;


/* Mostrar las Actividades de Conservación que han tenido un mayor impacto en la biodiversidad (mayor suma de Individuos Observados) */

SELECT AC.ID AS ACTIVIDAD_CONSERVACION_ID, AC.NOMBRE, AC.DESCRIPCION, AC.FECHA_REALIZACION,
SUM(O.NUMERO_INDIVIDUOS) AS SUMA_INDIVIDUOS_OBSERVADOS
FROM ACTIVIDAD_CONSERVACION AC 
JOIN OBSERVACION O ON AC.AREA_PROTEGIDA_ID = O.AREA_PROTEGIDA_ID
GROUP BY AC.ID, AC.NOMBRE, AC.DESCRIPCION, AC.FECHA_REALIZACION
ORDER BY SUMA_INDIVIDUOS_OBSERVADOS DESC;

/* Mostrar las Áreas Protegidas con una mayor diversidad de Especies (mayor cantidad de Especies distintas observadas) */

SELECT AP.ID AS AREA_PROTEGIDA_ID, AP.NOMBRE AS NOMBRE_AREA_PROTEGIDA, COUNT(DISTINCT OE.ESPECIE_ID) AS CANTIDAD_ESPECIES_OBSERVADAS
FROM AREA_PROTEGIDA AP
LEFT JOIN OBSERVACION O ON AP.ID = O.AREA_PROTEGIDA_ID
LEFT JOIN OBSERVACION_ESPECIE OE ON O.ID = OE.OBSERVACION_ID
GROUP BY AP.ID, AP.NOMBRE
ORDER BY CANTIDAD_ESPECIES_OBSERVADAS DESC;

/* Mostrar las Especies más amenazadas en función de la cantidad de Áreas Protegidas en las que están presentes */

SELECT E.ID AS ESPECIE_ID, E.NOMBRE_CIENTIFICO, E.NOMBRE_COMUN, COUNT(DISTINCT AA.AREA_PROTEGIDA_ID) AS NUM_AREAS_PROTEGIDAS
FROM ESPECIE E
JOIN OBSERVACION_ESPECIE OE ON E.ID = OE.ESPECIE_ID
JOIN OBSERVACION O ON OE.OBSERVACION_ID = O.ID
JOIN AREA_PROTEGIDA AP ON O.AREA_PROTEGIDA_ID = AP.ID
LEFT JOIN AREA_AMENAZADA AA ON AP.ID = AA.AREA_PROTEGIDA_ID
GROUP BY E.ID, E.NOMBRE_CIENTIFICO, E.NOMBRE_COMUN
ORDER BY NUM_AREAS_PROTEGIDAS DESC;